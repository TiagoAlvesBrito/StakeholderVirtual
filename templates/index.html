<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Stakeholder Virtual</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            width: 100%;
            overflow-y: auto;
            background: #fafafa;
        }
        .mensagem { margin-bottom: 8px; }
        .pergunta { font-weight: bold; color: #333; }
        .resposta { font-weight: bold; color: #0055aa; }
        .meta { font-size: 12px; color: #666; margin-bottom: 6px; }
        hr { border: none; border-top: 1px solid #eee; margin: 8px 0; }
        textarea { width: 100%; resize: vertical; padding: 8px; font-size: 14px; }
        button { margin-top: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Stakeholder Virtual</h1>
    <div id="chat"></div>

    <textarea id="pergunta" rows="3" placeholder="Digite sua pergunta (Shift+Enter para nova linha)"></textarea>
    <br>
    <button id="enviar">Enviar</button>

    <script>
    $(function() {
        function escapar(texto){
            return $('<div/>').text(texto).html();
        }

        function scrollParaFinal() {
            let chat = document.getElementById("chat");
            chat.scrollTop = chat.scrollHeight;
        }

        function enviar(){
            var pergunta = $('#pergunta').val().trim();
            if (!pergunta) return;
            $('#enviar').prop('disabled', true);

            $.post('/pergunta', { pergunta: pergunta })
            .done(function(data){
                var html = '';
                html += '<div class="mensagem pergunta">Pergunta: ' + escapar(pergunta) + '</div>';
                html += '<div class="mensagem resposta">Resposta: ' + escapar(data.resposta) + '</div>';
                html += '<div class="meta">Data e Hora: ' + escapar(data.data_hora) + '</div>';
                html += '<hr>';
                
                // AGORA É append → mensagens novas vão para baixo
                $('#chat').append(html);

                // mensagens no final, como WhatsApp
                scrollParaFinal();

                $('#pergunta').val('').focus();
            })
            .fail(function(xhr, status, err){
                alert('Erro ao enviar pergunta. Veja o console para detalhes.');
                console.error('POST /pergunta failed:', status, err, xhr.responseText);
            })
            .always(function(){
                $('#enviar').prop('disabled', false);
            });
        }

        $('#enviar').on('click', enviar);
        
        $('#pergunta').on('keydown', function(e){
            if (e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                enviar();
            }
        });
    });
    </script>
</body>
</html>
